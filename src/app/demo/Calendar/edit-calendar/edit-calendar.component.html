<div class="page-wrapper">
  <div class="card" *ngIf="!loading; else loadingTemplate">
    <div class="card-body">
      <div class="calendar-info">
        <div class="info-item">
          <span class="info-label">Organization:</span>
          <span class="info-value">{{ selectedOrg || 'N/A' }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Branch:</span>
          <span class="info-value">{{ selectedBranch || 'N/A' }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Year:</span>
          <span class="info-value">{{ selectedYear }}</span>
        </div>
      </div>

      <div class="calendar-legend">
        <div class="legend-item">
          <span class="legend-box full-day"></span>
          <span>Full Day</span>
        </div>
        <div class="legend-item">
          <span class="legend-box half-day"></span>
          <span>Half Day</span>
        </div>
      </div>

      <div class="calendar-grid">
        <div class="month" *ngFor="let monthIdx of months; let i = index">
          <h5 class="month-title">{{ months[i] }} {{ selectedYear }}</h5>
          <div class="weekdays">
            <div *ngFor="let day of daysOfWeek" class="weekday">{{ day }}</div>
          </div>
          <div class="days">
            <div
              class="day empty"
              *ngFor="let _ of [].constructor(getStartDayOfMonth(i))"
            ></div>
            <div
              *ngFor="let day of getCalendarDays(i)"
              [ngClass]="'day ' + getDayType(i, day)"
              [title]="getHolidayForDay(i, day)?.holidayName || ''"
              (click)="getHolidayForDay(i, day) ? onEditHoliday(getHolidayForDay(i, day)) : null"
              style="cursor: pointer;"
            >
              {{ day }}
            </div>
          </div>
        </div>
      </div>

      <!-- Removed in-page alert for showNoChangeConfirm, now handled by SweetAlert in TS -->

      <div class="actions mt-4">
        <button class="btn btn-outline-secondary me-2" (click)="navigateToCalendar()">
          <i class="fas fa-times me-1"></i> Cancel
        </button>
        <button class="btn btn-primary" (click)="onSave()">
          <i class="fas fa-save me-1"></i> Save Changes
        </button>
      </div>
    </div>
  </div>

  <ng-template #loadingTemplate>
    <div class="card">
      <div class="card-body text-center p-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 mb-0">Loading calendar data...</p>
      </div>
    </div>
  </ng-template>

  <app-event-modal
    *ngIf="eventModalVisible"
    [visible]="eventModalVisible"
    [month]="modalMonth"
    [year]="modalYear"
    [markedDays]="getMarkedDaysForModal()"
    (save)="handleModalSave($event)"
    (cancel)="closeEventModal()"
    (monthChanged)="onModalMonthChanged($event)"
  ></app-event-modal>

  <!-- Edit Holiday Modal -->
  <div class="modal fade show" tabindex="-1" style="display: block; background: rgba(0,0,0,0.5);" *ngIf="showEditModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit Holiday</h5>
          <button type="button" class="btn-close" (click)="closeEditModal()"></button>
        </div>
        <div class="modal-body">
          <form (ngSubmit)="handleEditModalSave(editHolidayData)">
            <div class="mb-3">
              <label class="form-label">Organization Name</label>
              <input type="text" class="form-control" [(ngModel)]="editHolidayData.organizationName" name="organizationName" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Branch Name</label>
              <input type="text" class="form-control" [(ngModel)]="editHolidayData.branchName" name="branchName" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Year</label>
              <input type="number" class="form-control" [(ngModel)]="editHolidayData.year" name="year" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Holiday Date</label>
              <input type="date" class="form-control" [(ngModel)]="editHolidayData.holidayDate" name="holidayDate" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Holiday Name</label>
              <input type="text" class="form-control" [(ngModel)]="editHolidayData.holidayName" name="holidayName" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Holiday Type</label>
              <select class="form-select" [(ngModel)]="editHolidayData.holidayType" name="holidayType" required>
                <option value="Public">Public</option>
                <option value="Private">Private</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Leave Day Type</label>
              <select class="form-select" [(ngModel)]="editHolidayData.leaveDayType" name="leaveDayType" required>
                <option value="Full Day">Full Day</option>
                <option value="Half Day">Half Day</option>
              </select>
            </div>
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" [(ngModel)]="editHolidayData.isOptional" name="isOptional" id="isOptionalEdit">
              <label class="form-check-label" for="isOptionalEdit">Optional Holiday</label>
            </div>
            <div class="form-check form-switch mb-3">
              <input class="form-check-input" type="checkbox" id="updateDeleteSwitch" [(ngModel)]="isDeleteMode" name="isDeleteMode">
              <label class="form-check-label" for="updateDeleteSwitch">
                {{ isDeleteMode ? 'Delete Mode' : 'Update Mode' }}
              </label>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" (click)="closeEditModal()">Cancel</button>
              <button type="submit" class="btn" [ngClass]="isDeleteMode ? 'btn-danger' : 'btn-primary'">
                {{ isDeleteMode ? 'Delete' : 'Save Changes' }}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
